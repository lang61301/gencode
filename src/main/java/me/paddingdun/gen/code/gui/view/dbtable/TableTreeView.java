/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package me.paddingdun.gen.code.gui.view.dbtable;

import java.awt.BorderLayout;
import java.awt.EventQueue;
import java.util.concurrent.Callable;

import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeModel;

import me.paddingdun.gen.code.data.message.Message;
import me.paddingdun.gen.code.data.tabletree.IDBTable;
import me.paddingdun.gen.code.db.TableHelper2;
import me.paddingdun.gen.code.gui.component.DragTree;
import me.paddingdun.gen.code.gui.model.TableTreeViewModel;
import me.paddingdun.gen.code.gui.perspective.designer.DesignerPerspective;
import me.paddingdun.gen.code.gui.view.AbstractView;
import me.paddingdun.gen.code.util.gui.TaskHelper;

/**
 * 数据库表试图;
 * @author paddingdun
 *
 * 2016年4月29日
 * @since 1.0
 * @version 2.0
 */
@SuppressWarnings("serial")
public class TableTreeView extends  AbstractView {
	
	private DesignerPerspective perspective;
	
	private TableTreeViewModel model = null;

    /**
     * Creates new form TableTreeFrame
     */
    public TableTreeView(DesignerPerspective perspective) {
    	super();
    	
    	this.perspective = perspective;
    	
    	initModel();
    	
        initComponents();
    }
    
    private void initModel(){
    	model = new TableTreeViewModel();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        setIconifiable(true);
        setMaximizable(true);
        setResizable(true);
        setTitle("数据库表");
        
        sp = new javax.swing.JScrollPane();
        tableTree = new DragTree();
        tableTree.setVisible(false);
        spp = new javax.swing.JSplitPane();
        pane = new javax.swing.JPanel();
        btnRefresh = new javax.swing.JButton();
        
        btnRefresh.setText("刷新");
        
        btnRefresh.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnRefreshActionPerformed(evt);
            }
        });

        this.addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentShown(java.awt.event.ComponentEvent evt) {
                afterShow(evt);
            }
        });
        spp.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        spp.setLeftComponent(sp);
        sp.setViewportView(tableTree);
        
		tableTree.addTreeSelectionListener(new TreeSelectionListener() {
			public void valueChanged(TreeSelectionEvent e) {
				treeValueChanged(e);
			}
		});
        
        spp.setBottomComponent(pane);
        
        pane.setLayout(new BorderLayout());
        pane.add(btnRefresh, BorderLayout.WEST);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(spp, javax.swing.GroupLayout.DEFAULT_SIZE, 394, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(spp, javax.swing.GroupLayout.DEFAULT_SIZE, 278, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void afterShow(java.awt.event.ComponentEvent evt) {//GEN-FIRST:event_afterShow
    	spp.setDividerLocation(0.9);

    	btnRefreshActionPerformed(null);
    }//GEN-LAST:event_afterShow
    
    private void treeValueChanged(TreeSelectionEvent e){
    	Object[] objs = e.getPath().getPath();
		DefaultMutableTreeNode node = (DefaultMutableTreeNode)objs[objs.length - 1];
		if(node.isLeaf()){
			Object uo = node.getUserObject();
			if( uo instanceof IDBTable){
				
				Message m = new Message(DesignerPerspective.MESSAGE_CLICK_TABLE_TREE_NODE);
				m.setSource(TableTreeView.this);
				m.setObject(uo);
				perspective.sendMessage(m);
			}
		}
    }
    
    private void btnRefreshActionPerformed(java.awt.event.ActionEvent evt) {
    	TaskHelper.runInNonEDT(new Callable<Void>() {
			public Void call() throws Exception {
				//设置数据;
				model.setRootNode(TableHelper2.TableTreeNode());
				
				final DefaultTreeModel tm = new DefaultTreeModel(model.getRootNode());
				EventQueue.invokeLater(new Runnable() {
					public void run() {
						tableTree.setModel(tm);
						tableTree.setVisible(true);
					}
				});
				return null;
			}
		});
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JSplitPane spp;
    private javax.swing.JPanel pane;
    private javax.swing.JScrollPane sp;
    private DragTree tableTree;
    private javax.swing.JButton btnRefresh;
    
    // End of variables declaration//GEN-END:variables

	/* (non-Javadoc)
	 * @see me.paddingdun.gen.code.gui.view.AbstractView#doMessage(me.paddingdun.gen.code.data.message.Message)
	 */
	@Override
	public void doMessage(Message message) {
		
	}
}
