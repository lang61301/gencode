/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package me.paddingdun.gen.code.gui.view.dbtable;

import java.awt.EventQueue;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.File;
import java.text.MessageFormat;
import java.util.List;
import java.util.Vector;
import java.util.concurrent.Callable;

import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

import org.apache.log4j.Logger;

import layout.TableLayout;
import me.paddingdun.gen.code.data.message.Message;
import me.paddingdun.gen.code.data.option.ModelValue;
import me.paddingdun.gen.code.data.option.ModelValueCategory;
import me.paddingdun.gen.code.data.option.Option;
import me.paddingdun.gen.code.data.table.TableColumn;
import me.paddingdun.gen.code.data.tabletree.Table;
import me.paddingdun.gen.code.db.TableHelper;
import me.paddingdun.gen.code.gui.perspective.designer.DesignerPerspective;
import me.paddingdun.gen.code.gui.view.AbstractView;
import me.paddingdun.gen.code.util.CollectionHelper;
import me.paddingdun.gen.code.util.FileHelper;
import me.paddingdun.gen.code.util.ModelHelper;
import me.paddingdun.gen.code.util.SpringHelper;
import me.paddingdun.gen.code.util.TaskHelper;
import me.paddingdun.gen.code.util.VelocityHelper;

/**
 *
 * @author admin
 */
public class TableView extends AbstractView {
	
	/**
	 * TableView 日志变量;
	 */
	private final static Logger logger = Logger.getLogger(TableView.class);


	private DesignerPerspective perspective;
	
	/**
	 * 数据;
	 */
	private TableViewModel model = null;
	
    /**
     * Creates new form TableFrame
     */
    public TableView(DesignerPerspective perspective) {
    	super();
    	this.perspective = perspective;
        initComponents();
    }
    
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

    	setIconifiable(true);
        setMaximizable(true);
        setResizable(true);
        setTitle("数据库表详细内容");
        fileChooser = new javax.swing.JFileChooser();
        p = new javax.swing.JSplitPane();
        pt = new javax.swing.JSplitPane();
        ptt = new javax.swing.JScrollPane();
        ptb = new javax.swing.JScrollPane();
        table = new javax.swing.JTable();
        pb = new javax.swing.JScrollPane();
        pba = new javax.swing.JPanel();
        ptba = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        basePackageName = new javax.swing.JTextField();
        btnGen = new javax.swing.JButton();
        btnOk = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        jcombo_sqlMapMarkUse = new javax.swing.JComboBox<Option<Integer>>();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        jLabel9 = new javax.swing.JLabel();
        jLabel10 = new javax.swing.JLabel();
        jLabel11 = new javax.swing.JLabel();
        jLabel12 = new javax.swing.JLabel();
        jLabel13 = new javax.swing.JLabel();
        jLabel14 = new javax.swing.JLabel();
        jLabel15 = new javax.swing.JLabel();
        jLabel16 = new javax.swing.JLabel();
        columnTitle = new javax.swing.JTextField();
        jcombo_showGsonAnnotation = new javax.swing.JComboBox<Option<Boolean>>();
        jcombo_queryRenderShow = new javax.swing.JComboBox<Option<Boolean>>();
        jcombo_listRenderShow = new javax.swing.JComboBox<Option<Boolean>>();
        jcombo_editRenderShow = new javax.swing.JComboBox<Option<Boolean>>();
        jcombo_queryRenderWay = new javax.swing.JComboBox<Option<Integer>>();
        jcombo_listRenderWay = new javax.swing.JComboBox<Option<Integer>>();
        jcombo_editRenderWay = new javax.swing.JComboBox<Option<Integer>>();
        saveMethodPrefix = new javax.swing.JTextField();
        updateMethodPrefix = new javax.swing.JTextField();
        getMethodPrefix = new javax.swing.JTextField();
        deleteMethodPrefix = new javax.swing.JTextField();
        queryMethodPrefix = new javax.swing.JTextField();
        queryPagingMethodPrefix = new javax.swing.JTextField();
        
        queryColumnJson = new javax.swing.JTextArea(1, 10);
        javax.swing.JScrollPane cqpc = new javax.swing.JScrollPane(queryColumnJson); 
//        customQueryProperty.setAutoscrolls(true);
        
        editValueGenWayJson = new javax.swing.JTextArea(1, 10);
        javax.swing.JScrollPane cevfw = new javax.swing.JScrollPane(editValueGenWayJson); 
        
        p.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        pt.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        ptt.setViewportView(table);

        p.setLeftComponent(pt);
        
        pt.setTopComponent(ptt);
        pt.setBottomComponent(ptb);
        
        pb.setHorizontalScrollBarPolicy(javax.swing.ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
//        ptb.setHorizontalScrollBarPolicy(javax.swing.ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
        ptb.setViewportView(ptba);
        
        jLabel1.setText("基础包名称");

        btnGen.setText("生成");
        btnOk.setText("Ok");

        jLabel2.setText("SQL传入值占位符");

//        sqlMapMarkUse.setModel(null);

        jLabel3.setText("保存方法前缀");

        jLabel4.setText("更新方法前缀");

        jLabel5.setText("获取方法前缀");

        jLabel6.setText("删除方法前缀");

        jLabel7.setText("列表方法前缀");

        jLabel8.setText("分页方法前缀");

        jLabel9.setText("是否显示gosn注释");
        
        jLabel10.setText("查询中是否显示");
        jLabel11.setText("查询中显示方式");
        
        jLabel12.setText("列表中是否显示");
        jLabel13.setText("列表中显示方式");
        
        jLabel14.setText("编辑中是否显示");
        jLabel15.setText("编辑中显示方式");
        
        jLabel16.setText("字段标题");
        
        TableLayout tableLayout_ptba = new TableLayout();
        double border = 2;			      		//0      1    2     3    4     5     6
        tableLayout_ptba.setColumn(new double[]{border, 50,  50,   80,  -1,  50,   70, border});
        tableLayout_ptba.setRow(new double[]{border,30, 30, 30, 130, 30, 30, 30, 30, 130, border});
        ptba.setLayout(tableLayout_ptba);
        
        queryRenderShow.addElement(CollectionHelper.option("是", Boolean.TRUE));
        queryRenderShow.addElement(CollectionHelper.option("否", Boolean.FALSE));
        jcombo_queryRenderShow.setModel(queryRenderShow);
        
        listRenderShow.addElement(CollectionHelper.option("是", Boolean.TRUE));
        listRenderShow.addElement(CollectionHelper.option("否", Boolean.FALSE));
        jcombo_listRenderShow.setModel(listRenderShow);
        
        editRenderShow.addElement(CollectionHelper.option("是", Boolean.TRUE));
        editRenderShow.addElement(CollectionHelper.option("否", Boolean.FALSE));
        jcombo_editRenderShow.setModel(editRenderShow);
        
        
        
        CollectionHelper.renderWayOption(queryRenderWay,"query");
        jcombo_queryRenderWay.setModel(queryRenderWay);

        CollectionHelper.renderWayOption(listRenderWay,"list");
        jcombo_listRenderWay.setModel(listRenderWay);

        CollectionHelper.renderWayOption(editRenderWay,"edit");
        jcombo_editRenderWay.setModel(editRenderWay);
        
        int row = 1;
        ptba.add(jLabel16, MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(columnTitle, MessageFormat.format("3,{0},4,{0}", row));
        
        row++;
        ptba.add(jLabel10, MessageFormat.format("1,{0},2,{0}", row, row));
        ptba.add(jcombo_queryRenderShow, MessageFormat.format("3,{0},4,{0}", row));
        ptba.add(btnOk, MessageFormat.format("6,{0}", row));
        row++;
        ptba.add(jLabel11, MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(jcombo_queryRenderWay, MessageFormat.format("3,{0},4,{0}", row));
        row++;
        ptba.add(new JLabel("查询字段"), MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(cqpc, MessageFormat.format("3,{0},6,{0}", row));
        
        row++;
        ptba.add(jLabel12, MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(jcombo_listRenderShow, MessageFormat.format("3,{0},4,{0}", row));
        row++;
        ptba.add(jLabel13, MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(jcombo_listRenderWay, MessageFormat.format("3,{0},4,{0}", row));
        
        row++;
        ptba.add(jLabel14, MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(jcombo_editRenderShow, MessageFormat.format("3,{0},4,{0}", row));
        row++;
        ptba.add(jLabel15, MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(jcombo_editRenderWay, MessageFormat.format("3,{0},4,{0}", row));
        row++;
        ptba.add(new JLabel("填值方式"), MessageFormat.format("1,{0},2,{0}", row));
        ptba.add(cevfw, MessageFormat.format("3,{0},6,{0}", row));

//        showGsonAnnotation.setModel(null);

        btnGen.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGenActionPerformed(evt);
            }
        });
        
        btnOk.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnOkActionPerformed(evt);
            }
        });
        
        TableLayout tableLayout_pba = new TableLayout();
//        double border = 2;			      //0      1    2     3    4     5     6
        tableLayout_pba.setColumn(new double[]{border, 50,  50,   80,  -1,  50,   70, border});
        tableLayout_pba.setRow(new double[]{border,30, 30, 30, 30, 30, 30, 30, 30, 30, 30, border});
        pba.setLayout(tableLayout_pba);
        
        pba.add(jLabel1, "1,1,2,1");
        pba.add(basePackageName, "3,1,5,1");
        pba.add(btnGen, "6,1");
        
        pba.add(jLabel2, "1,2,2,2");
        pba.add(jcombo_sqlMapMarkUse, "3,2,4,2");
        
        pba.add(jLabel9, "1,3,2,3");
        pba.add(jcombo_showGsonAnnotation, "3,3,4,3");
        
        pba.add(jLabel3, "1,4,2,4");
        pba.add(saveMethodPrefix, "3,4,4,4");
        
        pba.add(jLabel4, "1,5,2,5");
        pba.add(updateMethodPrefix, "3,5,4,5");
        
        pba.add(jLabel5, "1,6,2,6");
        pba.add(getMethodPrefix, "3,6,4,6");
        
        pba.add(jLabel6, "1,7,2,7");
        pba.add(deleteMethodPrefix, "3,7,4,7");
        
        pba.add(jLabel7, "1,8,2,8");
        pba.add(queryMethodPrefix, "3,8,4,8");
        
        pba.add(jLabel8, "1,9,2,9");
        pba.add(queryPagingMethodPrefix, "3,9,4,9");
        
        
        sqlMapMarkUse.addElement(CollectionHelper.option("属性名称", 1));
        sqlMapMarkUse.addElement(CollectionHelper.option("表字段名称", 2));
       jcombo_sqlMapMarkUse.setModel(sqlMapMarkUse);
       
       showGsonAnnotation.addElement(CollectionHelper.option("是", Boolean.TRUE));
       showGsonAnnotation.addElement(CollectionHelper.option("否", Boolean.FALSE));
       jcombo_showGsonAnnotation.setModel(showGsonAnnotation);
       
       
        
        pb.setViewportView(pba);

        p.setBottomComponent(pb);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(p, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 470, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(p, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 446, Short.MAX_VALUE)
        );
        

        
        
        
        
        this.addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentShown(java.awt.event.ComponentEvent evt) {
                afterShow(evt);
            }
        });
        
        pack();
    }// </editor-fold>//GEN-END:initComponents
    
    private void afterShow(java.awt.event.ComponentEvent evt) {//GEN-FIRST:event_afterShow
    	table.addMouseListener(new MouseAdapter() {
    	    @Override
    	    public void mouseClicked(MouseEvent e){
    	    	if(model != null
    	    			&& model.getTable() != null
    	    			&& model.getTable().getColumns() != null){
    	    		TaskHelper.runInNonEDT(new Callable<Void>() {
						public Void call() throws Exception {
							int index = table.getSelectedRow();
		    	    		List<TableColumn> list = model.getTable().getColumns();
		    	    		if(index < list.size()){
		    	    			final TableColumn tc = list.get(index);
		    	    			EventQueue.invokeLater(new Runnable() {
									public void run() {
										ModelHelper.simpleGetAndComplexSet(tc, TableView.this, ModelValueCategory.Column);
									}
								});
		    	    		}
							return null;
						}
    	    		});
    	    	}
    	    }
    	});
    	p.setDividerLocation(0.85);
    	
    	EventQueue.invokeLater(new Runnable() {
			public void run() {
				pt.setDividerLocation(0.4);
			}
		});
    }
    
    private void btnOkActionPerformed(java.awt.event.ActionEvent evt) {
    	if(model != null
    			&& model.getTable() != null
    			&& model.getTable().getColumns() != null){
    		TaskHelper.runInNonEDT(new Callable<Void>() {
				public Void call() throws Exception {
					int index = table.getSelectedRow();
    	    		List<TableColumn> list = model.getTable().getColumns();
    	    		if(index < list.size()){
    	    			TableColumn tc = list.get(index);
    	    			ModelHelper.complexGetAndSimpleSet(TableView.this, tc, ModelValueCategory.Column);
    	    			
    	    			//变更第4列(列别名)的值进入TableColumn
    	    			String ca = (String)table.getModel().getValueAt(index, 3);
    	    			TableColumn tmp_tc = new TableColumn(tc.getColumnName(), tc.getType(), tc.getColumnCommon());
    	    			tmp_tc.setColumnAlias(ca);
    	    			ModelHelper.complexGetAndSimpleSet(tmp_tc, tc, ModelValueCategory.Column);
    	    		}
					return null;
				}
    		});
    	}
    }
    
    private void btnGenActionPerformed(java.awt.event.ActionEvent evt) {
    	if(model!= null){
	    	fileChooser.setFileSelectionMode(JFileChooser.SAVE_DIALOG|JFileChooser.DIRECTORIES_ONLY);
	    	fileChooser.setCurrentDirectory(new File("C:\\Users\\admin\\Desktop"));
	        int opt = fileChooser.showSaveDialog(null);
	        //保存;
	        if(JFileChooser.APPROVE_OPTION == opt){
	        	TaskHelper.runInNonEDT(new Callable<Integer[]>() {
					public Integer[] call() throws Exception {
						File saveFile = fileChooser.getSelectedFile();
			        	if(!saveFile.exists())
			        		saveFile.mkdirs();
			        	//设置值;
			        	ModelHelper.complexGetAndSimpleSet(TableView.this, model);
			        	//加工model;
			        	ModelHelper.processTableViewModel(model);
			        	
			        	String javaContent = VelocityHelper.entityBean(model);
//			        	System.out.println(javaContent);
			        	FileHelper.genPojoJavaFile(saveFile.getAbsolutePath(), model.getPojoFullPackageName(), model.getTable().getEntityBeanName(), javaContent);
			        	
			        	String sqlMapContent = VelocityHelper.sqlMap(model);
			        	FileHelper.genSqlMapXmlFile(saveFile.getAbsolutePath(), model.getTable().getEntityBeanName(), sqlMapContent);
//			        	System.out.println(sqlMapContent);
			        	
			        	String bootstrapDataTableJspContent = VelocityHelper.bootstrapDataTableJsp(model);
			        	FileHelper.genBootstrapDataTableJspFile(saveFile.getAbsolutePath(), model.getJspWebinfAfterDir(), model.getTable().getEntityBeanName(), bootstrapDataTableJspContent);
			        	
			        	String sqlMapIDaoContent = VelocityHelper.sqlMapIDao(model);
			        	FileHelper.genSqlMapIDaoJavaFile(saveFile.getAbsolutePath(), model.getDaoFullPackageName(), model.getTable().getEntityBeanName(), sqlMapIDaoContent);
			        	
			        	String sqlMapDaoImplContent = VelocityHelper.sqlMapDaoImpl(model);
			        	FileHelper.genSqlMapDaoImplJavaFile(saveFile.getAbsolutePath(), model.getDaoImplFullPackageName(), model.getTable().getEntityBeanName(), sqlMapDaoImplContent);
			        	
			        	String sqlMapIServiceContent = VelocityHelper.sqlMapIService(model);
			        	FileHelper.genSqlMapIServiceJavaFile(saveFile.getAbsolutePath(), model.getServiceFullPackageName(), model.getTable().getEntityBeanName(), sqlMapIServiceContent);
			        	
			        	String sqlMapServiceImplContent = VelocityHelper.sqlMapServiceImpl(model);
			        	FileHelper.genSqlMapServiceImplJavaFile(saveFile.getAbsolutePath(), model.getServiceImplFullPackageName(), model.getTable().getEntityBeanName(), sqlMapServiceImplContent);
			        	
			        	String springWebActionContent = VelocityHelper.springWebAction(model);
			        	FileHelper.genSpringWebActionJavaFile(saveFile.getAbsolutePath(), model.getWebActionFullPackageName(), model.getTable().getEntityBeanName(), springWebActionContent);
			        	
			        	EventQueue.invokeLater(new Runnable() {
							public void run() {
								JOptionPane.showMessageDialog(null, "生成文件完成!");
							}
						});
						return null;
					}
				});
	        }
    	}
    }   


    // Variables declaration - do not modify//GEN-BEGIN:variables
    
    private javax.swing.JButton btnGen;
    private javax.swing.JButton btnOk;
    
    @ModelValue(valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField deleteMethodPrefix;
    private javax.swing.JFileChooser fileChooser;
    
    @ModelValue(valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField getMethodPrefix;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabel15;
    
    @ModelValue(valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField basePackageName;
    @ModelValue(valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField queryMethodPrefix;
    @ModelValue(valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField queryPagingMethodPrefix;
    @ModelValue(valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField saveMethodPrefix;
    private javax.swing.JComboBox<Option<Boolean>> jcombo_showGsonAnnotation;
    private javax.swing.JPanel pba;
    private javax.swing.JScrollPane pb;
    private javax.swing.JSplitPane p;
    private javax.swing.JSplitPane pt;
    private javax.swing.JScrollPane ptt;
    private javax.swing.JScrollPane ptb;
    private javax.swing.JPanel ptba;
    private javax.swing.JComboBox<Option<Integer>> jcombo_sqlMapMarkUse;
    private javax.swing.JTable table;
    @ModelValue(valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField updateMethodPrefix;
    
    @ModelValue()
    private OptionComboBoxModel<Integer> sqlMapMarkUse = new OptionComboBoxModel<Integer>();
    @ModelValue()
    private OptionComboBoxModel<Boolean> showGsonAnnotation = new OptionComboBoxModel<Boolean>();
    
    private javax.swing.JComboBox<Option<Integer>> jcombo_queryRenderWay;
    private javax.swing.JComboBox<Option<Integer>> jcombo_listRenderWay;
    private javax.swing.JComboBox<Option<Integer>> jcombo_editRenderWay;
    
    @ModelValue(category=ModelValueCategory.Column)
    private OptionComboBoxModel<Integer> queryRenderWay = new OptionComboBoxModel<Integer>();
    @ModelValue(category=ModelValueCategory.Column)
    private OptionComboBoxModel<Integer> listRenderWay = new OptionComboBoxModel<Integer>();
    @ModelValue(category=ModelValueCategory.Column)
    private OptionComboBoxModel<Integer> editRenderWay = new OptionComboBoxModel<Integer>();
    
    private javax.swing.JComboBox<Option<Boolean>> jcombo_queryRenderShow;
    private javax.swing.JComboBox<Option<Boolean>> jcombo_listRenderShow;
    private javax.swing.JComboBox<Option<Boolean>> jcombo_editRenderShow;
    
    @ModelValue(category=ModelValueCategory.Column)
    private OptionComboBoxModel<Boolean> queryRenderShow = new OptionComboBoxModel<Boolean>();
    @ModelValue(category=ModelValueCategory.Column)
    private OptionComboBoxModel<Boolean> listRenderShow = new OptionComboBoxModel<Boolean>();
    @ModelValue(category=ModelValueCategory.Column)
    private OptionComboBoxModel<Boolean> editRenderShow = new OptionComboBoxModel<Boolean>();
    
    private javax.swing.JLabel jLabel16;
    @ModelValue(category=ModelValueCategory.Column, valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextField columnTitle; 
    
    @ModelValue(category=ModelValueCategory.Column,valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextArea queryColumnJson;
    
    @ModelValue(category=ModelValueCategory.Column,valueGetFuncName = "getText", valueSetFuncName ="setText")
    private javax.swing.JTextArea editValueGenWayJson;
    
    
    private void initModel(Table t){
    	model = SpringHelper.getBean(TableViewModel.class);
    	ModelHelper.simpleGetAndComplexSet(model, TableView.this);
    	model.setTable(t);
    }
    
    // End of variables declaration//GEN-END:variables

	/* (non-Javadoc)
	 * @see me.paddingdun.gen.code.gui.view.AbstractView#doMessage(me.paddingdun.gen.code.data.message.Message)
	 */
	@Override
	public void doMessage(Message message) {
		//表格树点击消息;
		if(DesignerPerspective.MESSAGE_CLICK_TABLE_TREE_NODE.equals(message.getName())){
			final Table t = (Table)message.getObject();
			
			TaskHelper.runInNonEDT(new Callable<Integer[]>() {
				public Integer[] call() throws Exception {
					
					initModel(t);
					
					List<TableColumn> list_tr = TableHelper.tableColumn(t.getCat(), t.getTableName());
					t.setColumns(list_tr);
					
					Vector<Vector<Object>> v = TableHelper.transform1(list_tr);
					Vector<Object> v2 = new Vector<Object>();
//								DefaultTableColumnModel dtcm = new DefaultTableColumnModel();
			    	String[] heads = new String[]{"主键", "自增长", "列名称", "列别名", "列类型", "列描述"};
//			    	v2.add("select");
			    	for (int i = 0; i < heads.length; i++) {
//						    		TableColumn h = new TableColumn(i);
//						        	h.setHeaderValue(heads[i]);
//						        	dtcm.addColumn(h);
			        	v2.add(heads[i]);
					}
//						    	table.setColumnModel(dtcm);
					final DefaultTableModel dtm = new DefaultTableModel(v, v2){
						private static final long serialVersionUID = 1L;

						public Class<?> getColumnClass(int col){
							Object value = getValueAt(0, col);
					        if(value!=null)
					            return value.getClass();
					        else 
					        	return super.getClass();
						}
					};
					
					EventQueue.invokeLater(new Runnable() {
						public void run() {
							table.setModel(dtm);
					    	table.updateUI();
						}
					});
					return new Integer[]{0};
				}
			});
		}
	}
}
