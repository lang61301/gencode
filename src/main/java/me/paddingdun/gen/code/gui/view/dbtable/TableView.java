/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package me.paddingdun.gen.code.gui.view.dbtable;

import java.awt.EventQueue;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.File;
import java.io.StringReader;
import java.util.Formatter;
import java.util.List;
import java.util.Vector;
import java.util.concurrent.Callable;

import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

import org.apache.log4j.Logger;

import me.paddingdun.gen.code.data.message.Message;
import me.paddingdun.gen.code.data.table.TableColumn;
import me.paddingdun.gen.code.data.tabletree.Table;
import me.paddingdun.gen.code.db.TableHelper;
import me.paddingdun.gen.code.gui.perspective.designer.DesignerPerspective;
import me.paddingdun.gen.code.gui.view.AbstractView;
import me.paddingdun.gen.code.util.TaskHelper;
import me.paddingdun.gen.code.util.VelocityHelper;
import net.barenca.jastyle.ASFormatter;
import net.barenca.jastyle.FormatterHelper;

/**
 *
 * @author admin
 */
public class TableView extends AbstractView {
	
	/**
	 * TableView 日志变量;
	 */
	private final static Logger logger = Logger.getLogger(TableView.class);


	private DesignerPerspective perspective;
	
	private Table currentData = null;
	
    /**
     * Creates new form TableFrame
     */
    public TableView(DesignerPerspective perspective) {
    	super();
    	this.perspective = perspective;
        initComponents();
        
        init();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

    	setIconifiable(true);
        setMaximizable(true);
        setResizable(true);
        setTitle("数据库表详细内容");
        fileChooser = new javax.swing.JFileChooser();
        sp = new javax.swing.JScrollPane();
        table = new javax.swing.JTable();
        btnGen = new javax.swing.JButton();

        sp.setViewportView(table);
        
        this.addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentShown(java.awt.event.ComponentEvent evt) {
                afterShow(evt);
            }
        });
        
        btnGen.setText("生成");
        btnGen.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGenActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(sp, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 394, Short.MAX_VALUE)
            .addGroup(layout.createSequentialGroup()
                    .addComponent(btnGen)
                    .addGap(0, 0, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
        		layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(layout.createSequentialGroup()
                    .addComponent(sp, javax.swing.GroupLayout.PREFERRED_SIZE, 278, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGap(45, 45, 45)
                    .addComponent(btnGen)
                    .addContainerGap(413, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents
    
    private void afterShow(java.awt.event.ComponentEvent evt) {//GEN-FIRST:event_afterShow
    	table.addMouseListener(new MouseAdapter() {
    	    @Override
    	    public void mouseClicked(MouseEvent e){
    	    	System.out.println(table.getSelectedRow());
    	    }
    	});
    }
    
    private void btnGenActionPerformed(java.awt.event.ActionEvent evt) {
    	if(currentData != null){
	    	fileChooser.setFileSelectionMode(JFileChooser.SAVE_DIALOG|JFileChooser.DIRECTORIES_ONLY);
	        int opt = fileChooser.showSaveDialog(null);
	        //保存;
	        if(JFileChooser.APPROVE_OPTION == opt){
	        	TaskHelper.runInNonEDT(new Callable<Integer[]>() {
					public Integer[] call() throws Exception {
						File saveFile = fileChooser.getSelectedFile();
			        	if(!saveFile.exists())
			        		saveFile.mkdirs();
			        	ASFormatter formatter = new ASFormatter();
			        	formatter.setJavaStyle();
			        	System.out.println(FormatterHelper.format(new StringReader(VelocityHelper.entityBean(currentData)), formatter));
			        	
			        	System.out.println(VelocityHelper.sqlMap(currentData));
			        	
			        	
			        	System.out.println(VelocityHelper.dataTable(currentData));
			        	
			        	EventQueue.invokeLater(new Runnable() {
							public void run() {
								JOptionPane.showMessageDialog(null, "生成文件完成!");
							}
						});
						return null;
					}
				});
	        }
    	}
    }   


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnGen;
    private javax.swing.JFileChooser fileChooser;
    private javax.swing.JScrollPane sp;
    private javax.swing.JTable table;
    // End of variables declaration//GEN-END:variables

	/* (non-Javadoc)
	 * @see me.paddingdun.gen.code.gui.view.AbstractView#doMessage(me.paddingdun.gen.code.data.message.Message)
	 */
	@Override
	public void doMessage(Message message) {
		//表格树点击消息;
		if(DesignerPerspective.MESSAGE_CLICK_TABLE_TREE_NODE.equals(message.getName())){
			final Table t = (Table)message.getObject();
			
			TaskHelper.runInNonEDT(new Callable<Integer[]>() {
				public Integer[] call() throws Exception {
					
					List<TableColumn> list_tr = TableHelper.tableColumn(t.getCat(), t.getTableName());
					t.setColumns(list_tr);
					
					currentData = t;
					
					Vector<Vector<Object>> v = TableHelper.transform1(list_tr);
					Vector<Object> v2 = new Vector<Object>();
//								DefaultTableColumnModel dtcm = new DefaultTableColumnModel();
			    	String[] heads = new String[]{"列名称", "列类型", "列描述"};
//			    	v2.add("select");
			    	for (int i = 0; i < heads.length; i++) {
//						    		TableColumn h = new TableColumn(i);
//						        	h.setHeaderValue(heads[i]);
//						        	dtcm.addColumn(h);
			        	v2.add(heads[i]);
					}
//						    	table.setColumnModel(dtcm);
					final DefaultTableModel dtm = new DefaultTableModel(v, v2)/**{
						private static final long serialVersionUID = 1L;

						public Class<?> getColumnClass(int col){
							Object value = getValueAt(0, col);
					        if(value!=null)
					            return value.getClass();
					        else 
					        	return super.getClass();
						}
					}**/;
					
					EventQueue.invokeLater(new Runnable() {
						public void run() {
							table.setModel(dtm);
					    	table.updateUI();
						}
					});
					return new Integer[]{0};
				}
			});
		}
	}
}
